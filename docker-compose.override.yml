services:
  backend:
    # Backend image already has deps + CARLA installed via UV; just run uvicorn.
    command: ["/opt/venv/bin/uvicorn", "backend.main:app", "--host", "0.0.0.0", "--port", "7000", "--log-level", "info"]
    shm_size: "32g"
    volumes:
      # Read-only view of the repo so Storage assets are visible
      - ./:/app:ro
      # Writable mounts for outputs and run artifacts
      - ./Output:/app/Output
      - ./backend:/app/backend
      - ./pipeline_runs:/app/pipeline_runs
      # Windows host recording path (bind C:\... into the container)
      - C:/NUS/MachineLearning/GeneralML/recordings:/recordings:rw
      # CARLA wheel mount (extracted from CARLA_0.9.16.tar.gz)
      - ./CarlaLinux/extracted/PythonAPI/carla/dist:/carla_wheels:ro

  mlflow:
    volumes:
      - ./mlflow:/mlflow

  web:
    volumes:
      - ./WebUI:/usr/share/nginx/html:ro
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./:/repo:ro
